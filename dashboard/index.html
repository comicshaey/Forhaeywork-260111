<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>업무 대시보드</title>
  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/style.css" />

  <style>
    .topbar{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center; justify-content:flex-start;
      margin:10px 0 6px;
    }
    .pill{
      display:inline-block;
      padding:6px 10px;
      border:1px solid #d1d5db;
      border-radius:999px;
      background:#f9fafb;
      font-size:.95rem;
      color:#111;
      white-space:nowrap;
    }
    .banner{
      border:1px solid #e5e5e5;
      border-radius:14px;
      padding:14px 16px;
      margin:12px 0;
      background:#fff;
    }
    .banner.warn{
      border-color:#fca5a5;
      background:#fff1f2;
    }
    .banner-title{
      font-weight:800;
      color:#111;
      margin:0 0 8px;
      font-size:1.05rem;
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:8px 0 0;
    }
    .kpi .pill{ background:#fff; }
    .list{
      margin:0;
      padding-left:18px;
    }
    .list li{ margin:6px 0; }
    .tag{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#fafafa;
      font-size:.85rem;
      margin-right:6px;
      color:#333;
    }
    .tag.risk{ border-color:#fca5a5; background:#fff1f2; }
    .tag.approver{ border-color:#c7d2fe; background:#eef2ff; }
    .tag.channel{ border-color:#d1fae5; background:#ecfdf5; }
    .tag.absent{ border-color:#fb7185; background:#ffe4e6; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .small{ font-size:.95rem; color:#555; }
  </style>
</head>

<body>
<main class="container" style="max-width:880px; margin:0 auto; padding:24px 16px;">

  <h1>업무 대시보드</h1>
  <p class="muted">
    ·로컬 저장소 미사용(0) · 데이터는 GitHub JSON 관리<br/>
    ·오늘/내일/7일 요약: Task(분기 파일) + notes(달력 메모) + absence(부재/결재대행)
  </p>

  <div class="topbar">
    <a class="btn" href="/">메인</a>
    <a class="btn" href="/calendar/">학년도 달력</a>
    <a class="btn" id="goMonthly" href="/calendar/calendar-monthly-academic.html">월간(이번달)</a>
    <a class="btn" id="goWeekly" href="/calendar/calendar-weekly-academic.html">주간(이번주)</a>
  </div>

  <div class="section">
    <h2 class="local-h2" style="margin:0 0 10px;">상태 요약</h2>
    <div class="kpi" id="kpi"></div>
    <div class="small" id="kpiHint"></div>
  </div>

  <!-- 결재 지연 위험 배너 -->
  <div class="banner warn" id="approvalRiskBox" style="display:none;">
    <div class="banner-title">결재 지연 위험(오늘·내일)</div>
    <ul class="list" id="approvalRiskList"></ul>
    <div class="small" id="approvalRiskHint" style="margin-top:8px;"></div>
  </div>

  <div class="banner" id="todayBox">
    <div class="banner-title" id="todayTitle">오늘</div>
    <ul class="list" id="todayList"></ul>
  </div>

  <div class="banner" id="tomorrowBox">
    <div class="banner-title" id="tomorrowTitle">내일</div>
    <ul class="list" id="tomorrowList"></ul>
  </div>

  <div class="section">
    <h2 class="local-h2" style="margin:0 0 10px;">향후 7일</h2>
    <div id="weekRoot"></div>

    <p class="muted" style="margin-top:10px;">
      ·표시 우선순위: Task(마감/리스크) → notes(달력 메모) → 부재 참고<br/>
      ·notes: <span class="mono">/calendar/notes/notes-*.json</span><br/>
      ·tasks: <span class="mono">/data/tasks/tasks-YYYY-MM-MM.json</span><br/>
      ·absence: <span class="mono">/data/absence/absence-YYYY-MM-MM.json</span>
    </p>
  </div>

  <footer class="site-footer" style="text-align:center;">
    제작·운영: 씩씩하고 귀여운 고주무관 · 개인 전용
  </footer>

</main>

<script>
/* =========================
   유틸
========================= */
const pad = n => (n < 10 ? "0" : "") + n;

const ymd = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

const parseYmd = s => {
  const [y,m,d] = s.split("-").map(Number);
  return new Date(y, m-1, d);
};

const addDays = (d, n) => {
  const x = new Date(d);
  x.setDate(x.getDate() + n);
  return x;
};

const fmtK = d => {
  const wd = ["일","월","화","수","목","금","토"][d.getDay()];
  return `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}(${wd})`;
};

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/* =========================
   결재/처리 기본 시간대
   - Task.needBy가 없을 때 판정 기준
========================= */
const DEFAULT_WORK_START = "08:40";
const DEFAULT_WORK_END   = "16:40";

function toMin(hm){
  if(!hm) return null;
  const [h,m] = String(hm).split(":").map(Number);
  if(Number.isNaN(h) || Number.isNaN(m)) return null;
  return h*60 + m;
}

function overlap(a1, a2, b1, b2){
  // [a1,a2] 와 [b1,b2] 겹치면 true
  return Math.max(a1,b1) <= Math.min(a2,b2);
}

/* =========================
   달력 단축 링크
========================= */
function setCalendarShortcuts(today){
  const ym = `${today.getFullYear()}-${pad(today.getMonth()+1)}`;
  document.getElementById("goMonthly").href =
    `/calendar/calendar-monthly-academic.html?start=${ym}&months=1`;

  const s = new Date(today);
  s.setDate(s.getDate() - s.getDay());
  document.getElementById("goWeekly").href =
    `/calendar/calendar-weekly-academic.html?start=${ymd(s)}&weeks=1`;
}

/* =========================
   notes 로딩(기존 규칙 유지)
========================= */
function halfKeyByDate(dt){
  const y = dt.getFullYear(), m = dt.getMonth()+1;
  if(m >= 3 && m <= 8) return `${y}-03-08`;
  return `${(m >= 9 ? y : y-1)}-09-02`;
}

async function loadNotesForRange(startDate, days){
  const keys = new Set();
  for(let i=0;i<days;i++){
    keys.add(halfKeyByDate(addDays(startDate, i)));
  }
  const NOTES = {};
  await Promise.all([...keys].map(async k => {
    try{
      const r = await fetch(`/calendar/notes/notes-${k}.json`);
      if(!r.ok) return;
      Object.assign(NOTES, await r.json());
    }catch(e){}
  }));
  return NOTES;
}

/* =========================
   분기(3개월) 키: tasks/absence 공통
   - YYYY-01-03 / YYYY-04-06 / YYYY-07-09 / YYYY-10-12
========================= */
function quarterRangeKey(dt){
  const y = dt.getFullYear();
  const m = dt.getMonth() + 1;

  let start, end;
  if(m <= 3){ start = 1; end = 3; }
  else if(m <= 6){ start = 4; end = 6; }
  else if(m <= 9){ start = 7; end = 9; }
  else { start = 10; end = 12; }

  return `${y}-${pad(start)}-${pad(end)}`;
}

/* =========================
   tasks 로딩
========================= */
async function loadTasksForRange(startDate, days){
  const keys = new Set();
  for(let i=0;i<days;i++){
    keys.add(quarterRangeKey(addDays(startDate, i)));
  }

  let all = [];
  await Promise.all([...keys].map(async k => {
    try{
      const r = await fetch(`/data/tasks/tasks-${k}.json`);
      if(!r.ok) return;
      const data = await r.json();
      const arr = Array.isArray(data) ? data : (data.tasks || []);
      all = all.concat(arr);
    }catch(e){}
  }));

  return all
    .filter(t => t && typeof t.due === "string" && t.due.length >= 10)
    .sort((a,b) => (a.due < b.due ? -1 : a.due > b.due ? 1 : 0));
}

/* =========================
   absence 로딩
========================= */
async function loadAbsenceForRange(startDate, days){
  const keys = new Set();
  for(let i=0;i<days;i++){
    keys.add(quarterRangeKey(addDays(startDate, i)));
  }

  let all = [];
  await Promise.all([...keys].map(async k => {
    try{
      const r = await fetch(`/data/absence/absence-${k}.json`);
      if(!r.ok) return;
      const data = await r.json();
      const arr = Array.isArray(data) ? data : (data.absence || []);
      all = all.concat(arr);
    }catch(e){}
  }));

  all = all.filter(x => x && x.name && x.from && x.to);
  return all;
}

/* =========================
   absence 판정
   - 날짜 범위(from~to) 먼저 체크
   - 시간이 있으면(부분부재) task 기준 시간대와 겹칠 때만 "부재"로 판정
   - 시간이 없으면(종일부재) 무조건 "부재"로 판정
========================= */
function findAbsenceForTask(name, dateStr, absenceList, task){
  if(!name) return null;
  const n = String(name).trim();
  if(!n) return null;

  // task 시간(선택)
  const needBy = task && task.needBy ? String(task.needBy).trim() : "";
  const taskEndMin = needBy ? toMin(needBy) : null;

  const wStart = toMin(DEFAULT_WORK_START);
  const wEnd   = toMin(DEFAULT_WORK_END);

  const checkStart = wStart;
  const checkEndRaw = (taskEndMin !== null ? taskEndMin : wEnd);

  // 안전장치: 끝이 시작보다 이르면 시작으로 보정
  const checkEnd = Math.max(checkStart, checkEndRaw);

  for(const a of absenceList){
    if(String(a.name).trim() !== n) continue;
    if(!(a.from <= dateStr && dateStr <= a.to)) continue;

    // absence 시간이 없으면 종일 부재로 간주
    const aStartMin = toMin(a.startTime);
    const aEndMin   = toMin(a.endTime);
    if(aStartMin === null || aEndMin === null){
      return a;
    }

    // 부분 부재면 시간 겹침 검사
    if(overlap(checkStart, checkEnd, aStartMin, aEndMin)){
      return a;
    }
  }

  return null;
}

/* =========================
   렌더 helpers
========================= */
function makeTaskLine(t){
  const tags = [];
  if(t.risk) tags.push(`<span class="tag risk">리스크:${escapeHtml(t.risk)}</span>`);
  if(t.approver) tags.push(`<span class="tag approver">결재:${escapeHtml(t.approver)}</span>`);
  if(t.channel) tags.push(`<span class="tag channel">${escapeHtml(t.channel)}</span>`);

  const title = escapeHtml(t.title || "(제목없음)");
  const memo = t.memo ? ` <span class="small">— ${escapeHtml(t.memo)}</span>` : "";
  const needBy = t.needBy ? ` <span class="small">·기한 ${escapeHtml(t.needBy)}</span>` : "";
  return `${tags.join("")}${title}${needBy}${memo}`;
}

function fillUl(ul, items){
  ul.innerHTML = "";
  if(!items.length){
    ul.innerHTML = `<li class="muted">표시할 항목 없음</li>`;
    return;
  }
  ul.innerHTML = items.map(x => `<li>${x}</li>`).join("");
}

/* =========================
   실행
========================= */
(async function(){
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  setCalendarShortcuts(today);

  const DAYS = 8; // 오늘~7일
  const NOTES = await loadNotesForRange(today, DAYS);
  const TASKS = await loadTasksForRange(today, DAYS);
  const ABSENCE = await loadAbsenceForRange(today, DAYS);

  // 날짜별 task
  const byDateTasks = new Map();
  for(const t of TASKS){
    if(!byDateTasks.has(t.due)) byDateTasks.set(t.due, []);
    byDateTasks.get(t.due).push(t);
  }

  // KPI
  let due0=0, due1=0, due7=0;
  let approvalRiskCount=0;

  const todayKey = ymd(today);
  const tomorrowKey = ymd(addDays(today,1));

  for(let i=0;i<DAYS;i++){
    const key = ymd(addDays(today, i));
    const arr = (byDateTasks.get(key) || []);
    const n = arr.length;

    if(i===0) due0 += n;
    if(i===1) due1 += n;
    if(i>=0 && i<=7) due7 += n;

    // 결재 위험은 오늘/내일만 카운트
    if(i===0 || i===1){
      for(const t of arr){
        const ap = (t.approver || "").trim();
        if(!ap) continue;
        const a = findAbsenceForTask(ap, key, ABSENCE, t);
        if(a) approvalRiskCount++;
      }
    }
  }

  const n0 = (NOTES[todayKey] || "").trim() ? 1 : 0;
  const n1 = (NOTES[tomorrowKey] || "").trim() ? 1 : 0;

  const kpiHtml = [
    `<span class="pill">오늘 Task: <b>${due0}</b></span>`,
    `<span class="pill">내일 Task: <b>${due1}</b></span>`,
    `<span class="pill">7일 Task: <b>${due7}</b></span>`,
    `<span class="pill">결재 위험(오늘·내일): <b>${approvalRiskCount}</b></span>`,
    `<span class="pill">오늘 notes: <b>${n0}</b></span>`,
    `<span class="pill">내일 notes: <b>${n1}</b></span>`,
    `<span class="pill">기본 결재 가능시간: <b>${DEFAULT_WORK_START}~${DEFAULT_WORK_END}</b></span>`
  ];
  document.getElementById("kpi").innerHTML = kpiHtml.join("");

  // 로딩 분기 힌트
  const keyTodayQ = quarterRangeKey(today);
  const keyWeekEndQ = quarterRangeKey(addDays(today,7));
  const uniqQ = Array.from(new Set([keyTodayQ, keyWeekEndQ]));
  document.getElementById("kpiHint").innerHTML =
    `로딩 분기: <span class="mono">${uniqQ.join(", ")}</span>`;

  // 결재 지연 위험 배너(오늘/내일)
  const riskLines = [];
  const riskApprovers = new Set();

  function collectApprovalRisks(dateKey, label){
    const arr = (byDateTasks.get(dateKey) || []);
    for(const t of arr){
      const ap = (t.approver || "").trim();
      if(!ap) continue;

      const a = findAbsenceForTask(ap, dateKey, ABSENCE, t);
      if(!a) continue;

      riskApprovers.add(ap);

      const del = (a.delegate || "").trim();
      const delTxt = del ? ` / 대행: ${escapeHtml(del)}` : "";
      const typeTxt = a.type ? `(${escapeHtml(a.type)})` : "";
      const scopeTxt = a.scope ? ` · ${escapeHtml(a.scope)}` : "";
      const placeTxt = a.place ? ` · ${escapeHtml(a.place)}` : "";
      const timeTxt = (a.startTime && a.endTime) ? ` · ${escapeHtml(a.startTime)}~${escapeHtml(a.endTime)}` : " · 종일";
      const memoTxt = a.memo ? ` <span class="small">— ${escapeHtml(a.memo)}</span>` : "";

      riskLines.push(
        `<span class="tag absent">${escapeHtml(label)}</span>` +
        `<span class="tag approver">결재:${escapeHtml(ap)}</span>` +
        `${typeTxt}${scopeTxt}${placeTxt}${timeTxt} ` +
        `${escapeHtml(t.title || "(제목없음)")}` +
        ` <span class="small">·부재기간 ${escapeHtml(a.from)}~${escapeHtml(a.to)}${delTxt}</span>` +
        memoTxt
      );
    }
  }

  collectApprovalRisks(todayKey, "오늘");
  collectApprovalRisks(tomorrowKey, "내일");

  if(riskLines.length){
    document.getElementById("approvalRiskBox").style.display = "block";
    fillUl(document.getElementById("approvalRiskList"), riskLines);

    document.getElementById("approvalRiskHint").innerHTML =
      `부재 데이터: <span class="mono">/data/absence/absence-${keyTodayQ}.json</span>` +
      (keyTodayQ !== keyWeekEndQ ? `, <span class="mono">absence-${keyWeekEndQ}.json</span>` : "") +
      `<br/>매칭된 결재권자: <span class="mono">${Array.from(riskApprovers).join(", ")}</span>`;
  }

  // 오늘/내일 박스
  document.getElementById("todayTitle").textContent = `오늘 · ${fmtK(today)}`;
  document.getElementById("tomorrowTitle").textContent = `내일 · ${fmtK(addDays(today,1))}`;

  const todayItems = [];
  for(const t of (byDateTasks.get(todayKey) || [])){
    const ap = (t.approver || "").trim();
    const a = ap ? findAbsenceForTask(ap, todayKey, ABSENCE, t) : null;
    const extra = a ? ` <span class="tag absent">결재권자 부재</span>` : "";
    todayItems.push(extra + makeTaskLine(t));
  }
  const todayNote = (NOTES[todayKey] || "").trim();
  if(todayNote) todayItems.push(`<span class="tag">notes</span>${todayNote}`);

  const tomorrowItems = [];
  for(const t of (byDateTasks.get(tomorrowKey) || [])){
    const ap = (t.approver || "").trim();
    const a = ap ? findAbsenceForTask(ap, tomorrowKey, ABSENCE, t) : null;
    const extra = a ? ` <span class="tag absent">결재권자 부재</span>` : "";
    tomorrowItems.push(extra + makeTaskLine(t));
  }
  const tomorrowNote = (NOTES[tomorrowKey] || "").trim();
  if(tomorrowNote) tomorrowItems.push(`<span class="tag">notes</span>${tomorrowNote}`);

  fillUl(document.getElementById("todayList"), todayItems);
  fillUl(document.getElementById("tomorrowList"), tomorrowItems);

  // 향후 7일 카드
  const weekRoot = document.getElementById("weekRoot");
  weekRoot.innerHTML = "";

  for(let i=0;i<8;i++){
    const d = addDays(today, i);
    const key = ymd(d);

    const lines = [];
    for(const t of (byDateTasks.get(key) || [])){
      const ap = (t.approver || "").trim();
      const a = ap ? findAbsenceForTask(ap, key, ABSENCE, t) : null;
      const extra = a ? ` <span class="tag absent">결재권자 부재</span>` : "";
      lines.push(extra + makeTaskLine(t));
    }

    const note = (NOTES[key] || "").trim();
    if(note) lines.push(`<span class="tag">notes</span>${note}`);

    if(!lines.length) continue;

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div style="font-weight:800; margin-bottom:6px;">${fmtK(d)}</div>
      <ul class="list">${lines.map(x => `<li>${x}</li>`).join("")}</ul>
    `;
    weekRoot.appendChild(card);
  }

  if(!weekRoot.children.length){
    weekRoot.innerHTML = `<p class="muted">향후 7일에 표시할 Task/notes가 없습니다.</p>`;
  }
})();
</script>

<script src="/static/disable-copy.js"></script>
<script src="/static/global-loader.js?v=1"></script>
</body>
</html>
