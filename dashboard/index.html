<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>마감기한 임박 업무 대시보드</title>

  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/style.css" />

  <style>
    :root{
      --line:#e5e5e5;
      --black:#111;
      --muted:#666;
      --chip:#f3f4f6;
      --danger:#c8352d;
      --warn:#b45309;
      --ok:#0f766e;
    }

    .wrap{max-width:880px; margin:0 auto; padding:24px 16px;}
    h1{font-size:1.75rem; margin:18px 0 8px; text-align:left !important;}
    .subtitle{margin:0 0 12px; color:#444; font-size:0.98rem}
    .muted{color:var(--muted); font-size:0.95rem}
    hr{border:none; border-top:1px solid #ddd; margin:20px 0;}

    .section{
      border:1px solid var(--line);
      border-radius:12px;
      padding:16px 18px;
      margin:18px 0;
      background:#fff;
    }

    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .topbar .left{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:var(--chip);
      border:1px solid #e6e6e6;
      font-size:0.9rem;
      color:#333;
    }
    .pill b{color:#111}

    .btn{
      display:inline-block;
      padding:10px 16px;
      border-radius:12px;
      border:1px solid #222;
      text-decoration:none;
      color:#111;
      font-weight:600;
      background:#fff;
    }
    .btn:hover{background:#f3f4f6;}
    .btn.primary{background:#111; color:#fff;}
    .btn.primary:hover{background:#000;}
    .btn + .btn{margin-left:8px;}

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-top:10px;
    }
    .controls input[type="date"]{min-width:160px;}
    .controls select{min-width:160px;}

    .grid{
      display:grid;
      gap:12px;
      margin-top:12px;
    }

    .card{
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px 14px 12px;
      background:#fafafa;
    }
    .card-head{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .title{
      font-weight:800;
      color:#111;
      font-size:1.05rem;
      line-height:1.35;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      justify-content:flex-end;
    }
    .chip{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      background:#fff;
      border:1px solid #e6e6e6;
      font-size:0.85rem;
      color:#333;
    }
    .chip.due-danger{border-color:rgba(200,53,45,.35); color:var(--danger); font-weight:800;}
    .chip.due-warn{border-color:rgba(180,83,9,.35); color:var(--warn); font-weight:800;}
    .chip.due-ok{border-color:rgba(15,118,110,.35); color:var(--ok); font-weight:800;}

    /* ✅ 줄바꿈 보존(핵심) */
    .white-pre{
      white-space: pre-wrap;
      overflow-wrap:anywhere;
      line-height:1.5;
    }

    .desc{
      margin-top:6px;
      color:#333;
      font-size:0.95rem;
    }

    .empty{
      padding:14px;
      border:1px dashed #d7d7d7;
      border-radius:12px;
      background:#fff;
      color:#666;
      font-size:0.95rem;
    }

    footer{
      margin:18px 0 8px;
      color:#555;
      font-size:.9rem;
      text-align:center;
    }
  </style>
</head>

<body>
  <main class="wrap">
    <h1>마감기한 임박 업무 대시보드</h1>
    <p class="subtitle">오늘 · 내일 · 7일 이내 마감만 자동 추출</p>

    <div class="topbar">
      <div class="left">
        <span class="pill">기준일: <b id="baseLabel">-</b></span>
        <span class="pill">불러온 파일: <b id="filesLabel">-</b></span>
      </div>
      <div>
        <a class="btn" href="/">메인으로</a>
        <a class="btn" href="/calendar/">달력</a>
      </div>
    </div>

    <div class="section">
      <div class="muted">
        · 데이터는 GitHub에 올린 JSON에서만 불러옵니다(로컬 저장 0).<br/>
        · 파일 규칙: <b>/dashboard/tasks/tasks-YYYY-MM-03.json</b> (3개월 단위)
      </div>

      <div class="controls">
        <label class="muted">기준일:
          <input type="date" id="baseDateInput" />
        </label>

        <label class="muted">범위:
          <select id="rangeSel">
            <option value="0">오늘만</option>
            <option value="1">오늘~내일</option>
            <option value="7" selected>오늘~7일</option>
            <option value="14">오늘~14일</option>
          </select>
        </label>

        <button class="btn primary" id="reloadBtn" type="button">다시 불러오기</button>
      </div>
    </div>

    <section class="section">
      <h2 style="font-size:1.2rem; margin:0 0 12px">임박 업무</h2>
      <hr />
      <div id="root" class="grid"></div>
    </section>

    <footer>
      제작·운영: 씩씩하고 귀여운 고주무관 · 개인 전용
    </footer>
  </main>

  <script src="/static/disable-copy.js"></script>
  <script src="/static/global-loader.js?v=1"></script>

  <script>
    // =========================
    //  설정
    // =========================
    const TASKS_DIR = "/dashboard/tasks/";
    const FILE_DAY = 3; // ✅ 네 규칙: tasks-YYYY-MM-03.json
    const MAX_LOAD_MONTHS_AHEAD = 6; // 안전빵: 현재~다음 6개월 범위의 파일까지

    // =========================
    //  유틸
    // =========================
    const pad = n => (n < 10 ? "0" : "") + n;
    const ymd = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const parseYmd = (s) => {
      const [y,m,d] = (s||"").split("-").map(Number);
      if(!y || !m || !d) return null;
      return new Date(y, m-1, d);
    };
    const addDays = (d,n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
    const addMonths = (d,n) => new Date(d.getFullYear(), d.getMonth()+n, 1);
    const startOfDay = (d) => new Date(d.getFullYear(), d.getMonth(), d.getDate());

    // 분기 시작월(1,4,7,10) + FILE_DAY로 파일 키 만들기
    function quarterStartKeyByDate(date){
      const y = date.getFullYear();
      const m = date.getMonth()+1;
      let qm = 1;
      if(m>=10) qm=10;
      else if(m>=7) qm=7;
      else if(m>=4) qm=4;
      else qm=1;
      return `${y}-${pad(qm)}-${pad(FILE_DAY)}`;
    }

    // 기준일~몇개월치에 걸쳐 필요한 파일 키 목록(최소 2개 이상 로드해서 누락 방지)
    function collectQuarterKeys(baseDate, monthsAhead){
      const set = new Set();
      for(let i=0;i<=monthsAhead;i++){
        const d = addMonths(baseDate, i);
        set.add(quarterStartKeyByDate(d));
      }
      return [...set];
    }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // D-day 라벨
    function dueClass(diffDays){
      if(diffDays < 0) return "due-ok"; // 지난 건은 일단 ok로
      if(diffDays <= 1) return "due-danger";
      if(diffDays <= 7) return "due-warn";
      return "due-ok";
    }
    function dueLabel(diffDays){
      if(diffDays < 0) return `D+${Math.abs(diffDays)}`;
      if(diffDays === 0) return "D-Day";
      return `D-${diffDays}`;
    }

    // =========================
    //  데이터 로드
    // =========================
    async function fetchJson(url){
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    // tasks JSON 포맷(권장):
    // {
    //   "tasks": [
    //     { "id":"...", "title":"...", "due":"YYYY-MM-DD", "category":"...", "desc":"줄1\n줄2", "owner":"", "status":"" }
    //   ]
    // }
    async function loadTasksForBase(baseDate){
      const keys = collectQuarterKeys(baseDate, MAX_LOAD_MONTHS_AHEAD);
      const urls = keys.map(k => `${TASKS_DIR}tasks-${k}.json`);
      const loaded = [];
      const okUrls = [];

      await Promise.all(urls.map(async (u)=>{
        try{
          const j = await fetchJson(u);
          const arr = Array.isArray(j.tasks) ? j.tasks : (Array.isArray(j) ? j : []);
          loaded.push(...arr);
          okUrls.push(u);
        }catch(e){
          // 파일이 없으면 조용히 스킵(네가 깃에 아직 안 올렸을 수 있음)
        }
      }));

      return { tasks: loaded, urls: okUrls };
    }

    // =========================
    //  렌더
    // =========================
    function render(tasks, baseDate, rangeDays){
      const root = document.getElementById("root");
      root.innerHTML = "";

      const base = startOfDay(baseDate);
      const end = addDays(base, rangeDays);

      // due 있는 것만 + 범위 필터
      const filtered = (tasks||[])
        .map(t => {
          const due = parseYmd(t.due);
          return { ...t, _due: due };
        })
        .filter(t => t._due && startOfDay(t._due) >= base && startOfDay(t._due) <= end)
        .sort((a,b)=> startOfDay(a._due) - startOfDay(b._due));

      if(filtered.length === 0){
        root.innerHTML = `<div class="empty">해당 범위에 임박 업무가 없습니다.</div>`;
        return;
      }

      for(const t of filtered){
        const due = startOfDay(t._due);
        const diffDays = Math.round((due - base) / (1000*60*60*24));

        const title = escapeHtml(t.title || "(제목 없음)");
        const cat = escapeHtml(t.category || "");
        const owner = escapeHtml(t.owner || "");
        const status = escapeHtml(t.status || "");
        const desc = escapeHtml(t.desc || t.memo || "");

        const chips = [];
        chips.push(`<span class="chip ${dueClass(diffDays)}">${dueLabel(diffDays)}</span>`);
        chips.push(`<span class="chip">마감: ${ymd(due)}</span>`);
        if(cat) chips.push(`<span class="chip">${cat}</span>`);
        if(owner) chips.push(`<span class="chip">담당: ${owner}</span>`);
        if(status) chips.push(`<span class="chip">상태: ${status}</span>`);

        const el = document.createElement("div");
        el.className = "card";
        el.innerHTML = `
          <div class="card-head">
            <div class="title">${title}</div>
            <div class="meta">${chips.join("")}</div>
          </div>
          ${desc ? `<div class="desc white-pre">${desc}</div>` : ``}
        `;
        root.appendChild(el);
      }
    }

    // =========================
    //  초기/이벤트
    // =========================
    const baseLabel = document.getElementById("baseLabel");
    const filesLabel = document.getElementById("filesLabel");
    const baseDateInput = document.getElementById("baseDateInput");
    const rangeSel = document.getElementById("rangeSel");
    const reloadBtn = document.getElementById("reloadBtn");

    function setUiBaseDate(d){
      baseDateInput.value = ymd(d);
      baseLabel.textContent = ymd(d);
    }

    async function refresh(){
      const base = parseYmd(baseDateInput.value) || new Date();
      const rangeDays = parseInt(rangeSel.value, 10) || 7;

      baseLabel.textContent = ymd(base);

      const { tasks, urls } = await loadTasksForBase(base);
      filesLabel.textContent = urls.length ? urls.map(u => u.replace(TASKS_DIR,"")).join(", ") : "(없음)";

      render(tasks, startOfDay(base), rangeDays);
    }

    // 초기 기준일: 오늘
    setUiBaseDate(new Date());

    reloadBtn.addEventListener("click", refresh);
    baseDateInput.addEventListener("change", refresh);
    rangeSel.addEventListener("change", refresh);

    // 첫 로드
    refresh();
  </script>
</body>
</html>
